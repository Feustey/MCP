version: '3.8'

services:
  # MongoDB Service
  mongodb:
    image: mongo:7.0
    container_name: mcp-mongodb
    restart: unless-stopped
    environment:
      # MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-mcpuser}
      # MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-ChangeThisPassword123!}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-mcp_prod}
    # ports:
    #   - "127.0.0.1:27017:27017"  # Non exposé - accès interne Docker uniquement
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - mcp-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    command: mongod --auth
  
  # Redis Service (with RediSearch for RAG optimizations)
  redis:
    image: redis/redis-stack:latest
    container_name: mcp-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-ChangeThisRedisPass123!}
      --loadmodule /opt/redis-stack/lib/redisearch.so
      --loadmodule /opt/redis-stack/lib/rejson.so
    # ports:
    #   - "127.0.0.1:6379:6379"  # Non exposé - accès interne Docker uniquement
    volumes:
      - redis_data:/data
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-ChangeThisRedisPass123!}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    environment:
      - REDIS_ARGS=--requirepass ${REDIS_PASSWORD:-ChangeThisRedisPass123!}

  # MCP API Service
  mcp-api:
    image: mcp-api:latest
    container_name: mcp-api
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.production
    ports:
      - "127.0.0.1:8000:8000"
    env_file:
      - .env
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_WORKERS=2
      
      # MongoDB (connexion interne Docker)
      - MONGODB_URL=mongodb://${MONGODB_USER:-mcpuser}:${MONGODB_PASSWORD:-ChangeThisPassword123!}@mongodb:27017/${MONGODB_DATABASE:-mcp_prod}?authSource=admin
      - MONGO_URL=mongodb://${MONGODB_USER:-mcpuser}:${MONGODB_PASSWORD:-ChangeThisPassword123!}@mongodb:27017/${MONGODB_DATABASE:-mcp_prod}?authSource=admin
      - MONGODB_DATABASE=${MONGODB_DATABASE:-mcp_prod}
      - MONGO_NAME=${MONGODB_DATABASE:-mcp_prod}
      
      # Redis (connexion interne Docker)
      - REDIS_URL=redis://:${REDIS_PASSWORD:-ChangeThisRedisPass123!}@redis:6379
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-ChangeThisRedisPass123!}
      
      # Sécurité
      - SECRET_KEY=${SECRET_KEY}
      - SECURITY_SECRET_KEY=${SECRET_KEY}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Mode et features
      - DRY_RUN=${DRY_RUN:-true}
      - ENABLE_SHADOW_MODE=${ENABLE_SHADOW_MODE:-true}
      - ENABLE_RAG=true
      # RAG / Ollama (modèles ultra-légers pour 2GB RAM)
      - OLLAMA_URL=http://ollama:11434
      - GEN_MODEL=gemma3:1b
      - GEN_MODEL_FALLBACK=tinyllama
      - EMBED_MODEL=nomic-embed-text
      
      # RAG Optimizations (Nov 2025)
      - ENABLE_HYBRID_SEARCH=true
      - ENABLE_QUERY_EXPANSION=true
      - ENABLE_ADVANCED_RERANKING=true
      - ENABLE_DYNAMIC_CONTEXT=true
      - INDEX_TYPE=redis_hnsw
      
      # LNBits
      - LNBITS_URL=${LNBITS_URL}
      - LNBITS_ADMIN_KEY=${LNBITS_ADMIN_KEY}
      - LNBITS_INVOICE_KEY=${LNBITS_INVOICE_KEY:-demo_invoice_key}
      - LNBITS_INKEY=${LNBITS_INVOICE_KEY:-demo_invoice_key}
      
      # AI / OpenAI (optionnel pour Shadow Mode)
      - AI_OPENAI_API_KEY=${AI_OPENAI_API_KEY:-sk-dummy-key}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-sk-ant-dummy-key}
      
      # Monitoring
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./config:/app/config:ro
      - ./app:/app/app:ro
    networks:
      - mcp-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: mcp-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-docker.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - mcp-network
    depends_on:
      - mcp-api
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Ollama Service (local inference)
  ollama:
    image: ollama/ollama:latest
    container_name: mcp-ollama
    restart: unless-stopped
    ports:
      - "127.0.0.1:11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sf http://localhost:11434/api/tags >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  nginx_logs:
    driver: local
  ollama_data:
    driver: local

networks:
  mcp-network:
    driver: bridge
