#!/bin/bash
# Script de mise Ã  jour MCP RAG sur Hostinger via git pull
# DerniÃ¨re mise Ã  jour: 7 janvier 2025

set -e

# Configuration
SSH_HOST="u123456789@your-hostinger-server.com"  # Ã€ remplacer par vos vraies credentials
SSH_PORT="22"
PROJECT_DIR="~/mcp-rag"
BRANCH="berty"

# Couleurs pour les logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1"
    exit 1
}

# VÃ©rification des prÃ©requis
check_prerequisites() {
    log "VÃ©rification des prÃ©requis..."
    
    # VÃ©rifier SSH
    if ! command -v ssh &> /dev/null; then
        error "SSH n'est pas installÃ©"
    fi
    
    # Tester la connexion SSH
    if ! ssh -p $SSH_PORT -o ConnectTimeout=10 $SSH_HOST "echo 'Connexion SSH OK'" &> /dev/null; then
        error "Impossible de se connecter au serveur Hostinger"
    fi
    
    log "PrÃ©requis vÃ©rifiÃ©s avec succÃ¨s"
}

# Sauvegarde avant mise Ã  jour
backup_before_update() {
    log "Sauvegarde avant mise Ã  jour..."
    
    ssh -p $SSH_PORT $SSH_HOST << EOF
        cd $PROJECT_DIR
        
        # CrÃ©er une sauvegarde avec timestamp
        BACKUP_NAME="backup-before-update-\$(date +%Y%m%d_%H%M%S)"
        
        # Sauvegarder les fichiers importants
        tar -czf "\$BACKUP_NAME.tar.gz" \
            data/ \
            rag/ \
            logs/ \
            config/ \
            .env* \
            2>/dev/null || true
            
        echo "Sauvegarde crÃ©Ã©e: \$BACKUP_NAME.tar.gz"
EOF
    
    log "Sauvegarde terminÃ©e"
}

# VÃ©rification de l'Ã©tat git
check_git_status() {
    log "VÃ©rification de l'Ã©tat git..."
    
    ssh -p $SSH_PORT $SSH_HOST << EOF
        cd $PROJECT_DIR
        
        echo "=== Ã‰tat du repository ==="
        git status --porcelain
        
        echo ""
        echo "=== Branche actuelle ==="
        git branch --show-current
        
        echo ""
        echo "=== Derniers commits ==="
        git log --oneline -5
        
        echo ""
        echo "=== DiffÃ©rences avec origin ==="
        git fetch origin
        git log --oneline HEAD..origin/$BRANCH
EOF
}

# Mise Ã  jour via git pull
update_via_git_pull() {
    log "Mise Ã  jour via git pull..."
    
    ssh -p $SSH_PORT $SSH_HOST << EOF
        cd $PROJECT_DIR
        
        # Sauvegarder les modifications locales si elles existent
        if [ -n "\$(git status --porcelain)" ]; then
            echo "Modifications locales dÃ©tectÃ©es, crÃ©ation d'un stash..."
            git stash push -m "Auto-stash before pull \$(date)"
        fi
        
        # Fetch des derniÃ¨res modifications
        echo "Fetch des derniÃ¨res modifications..."
        git fetch origin
        
        # VÃ©rifier s'il y a des modifications
        if [ "\$(git rev-list HEAD..origin/$BRANCH --count)" -eq "0" ]; then
            echo "Aucune nouvelle modification disponible"
            exit 0
        fi
        
        # Pull des modifications
        echo "Pull des modifications depuis origin/$BRANCH..."
        git pull origin $BRANCH
        
        # Restaurer les modifications locales si nÃ©cessaire
        if git stash list | grep -q "Auto-stash before pull"; then
            echo "Restauration des modifications locales..."
            git stash pop
        fi
        
        echo "Mise Ã  jour git terminÃ©e"
EOF
    
    log "Mise Ã  jour git terminÃ©e"
}

# Mise Ã  jour des dÃ©pendances
update_dependencies() {
    log "Mise Ã  jour des dÃ©pendances..."
    
    ssh -p $SSH_PORT $SSH_HOST << EOF
        cd $PROJECT_DIR
        
        # VÃ©rifier si requirements.txt a changÃ©
        if git diff --name-only HEAD~1 HEAD | grep -q "requirements"; then
            echo "Requirements modifiÃ©s, mise Ã  jour des dÃ©pendances..."
            
            # Installer les nouvelles dÃ©pendances
            pip install -r requirements-hostinger.txt --upgrade || true
        else
            echo "Aucune modification des requirements dÃ©tectÃ©e"
        fi
EOF
    
    log "DÃ©pendances mises Ã  jour"
}

# RedÃ©marrage des services
restart_services() {
    log "RedÃ©marrage des services..."
    
    ssh -p $SSH_PORT $SSH_HOST << EOF
        cd $PROJECT_DIR
        
        # ArrÃªt des services
        echo "ArrÃªt des services..."
        docker-compose -f docker-compose.hostinger.yml down
        
        # Pull de la derniÃ¨re image si nÃ©cessaire
        echo "Pull de la derniÃ¨re image Docker..."
        docker pull feustey/dazno:latest
        
        # RedÃ©marrage des services
        echo "RedÃ©marrage des services..."
        docker-compose -f docker-compose.hostinger.yml up -d
        
        # Attente du dÃ©marrage
        echo "Attente du dÃ©marrage des services..."
        sleep 30
        
        # VÃ©rification de la santÃ©
        echo "VÃ©rification de la santÃ© des services..."
        docker-compose -f docker-compose.hostinger.yml ps
EOF
    
    log "Services redÃ©marrÃ©s"
}

# VÃ©rification post-mise Ã  jour
post_update_check() {
    log "VÃ©rification post-mise Ã  jour..."
    
    # Test de l'API
    log "Test de l'API..."
    if curl -f -s https://api.dazno.de/api/v1/health > /dev/null; then
        log "âœ… API accessible"
    else
        warn "âš ï¸ API non accessible"
    fi
    
    # Test des endpoints RAG
    log "Test des endpoints RAG..."
    if curl -f -s https://api.dazno.de/api/v1/rag/health > /dev/null; then
        log "âœ… Endpoints RAG accessibles"
    else
        warn "âš ï¸ Endpoints RAG non accessibles"
    fi
    
    # Test des endpoints Intelligence
    log "Test des endpoints Intelligence..."
    if curl -f -s https://api.dazno.de/api/v1/intelligence/health/intelligence > /dev/null; then
        log "âœ… Endpoints Intelligence accessibles"
    else
        warn "âš ï¸ Endpoints Intelligence non accessibles"
    fi
    
    log "VÃ©rification post-mise Ã  jour terminÃ©e"
}

# Affichage des informations de mise Ã  jour
show_update_info() {
    log "Informations de mise Ã  jour:"
    echo ""
    echo "ğŸ”„ Mise Ã  jour terminÃ©e"
    echo "ğŸŒ API: https://api.dazno.de"
    echo "ğŸ“Š Documentation: https://api.dazno.de/docs"
    echo ""
    echo "ğŸ“‹ Logs: ssh $SSH_HOST 'cd $PROJECT_DIR && docker-compose -f docker-compose.hostinger.yml logs -f'"
    echo "ğŸ”„ RedÃ©marrage manuel: ssh $SSH_HOST 'cd $PROJECT_DIR && docker-compose -f docker-compose.hostinger.yml restart'"
    echo "ğŸ›‘ ArrÃªt: ssh $SSH_HOST 'cd $PROJECT_DIR && docker-compose -f docker-compose.hostinger.yml down'"
    echo ""
}

# Fonction principale
main() {
    log "ğŸ”„ DÃ©marrage de la mise Ã  jour MCP RAG sur Hostinger"
    log "Serveur: $SSH_HOST"
    log "Branche: $BRANCH"
    echo ""
    
    check_prerequisites
    backup_before_update
    check_git_status
    update_via_git_pull
    update_dependencies
    restart_services
    post_update_check
    show_update_info
    
    log "âœ… Mise Ã  jour terminÃ©e avec succÃ¨s!"
}

# Gestion des erreurs
trap 'error "Erreur lors de la mise Ã  jour"' ERR

# ExÃ©cution
main "$@" 