#!/usr/bin/expect -f

set timeout 120
set host "147.79.101.32"
set user "feustey"
set password "Feustey@AI!"

spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    "*$*" {
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        
        # Configurer les vraies variables Telegram
        send "sed -i 's/TELEGRAM_BOT_TOKEN=DEMO_MODE/TELEGRAM_BOT_TOKEN=7676575630:AAEE4ds5F9XAvqU1JtAGY-_BFN0KDSAkvDQ/' .env\r"
        expect "*$*"
        
        send "sed -i 's/TELEGRAM_CHAT_ID=DEMO_MODE/TELEGRAM_CHAT_ID=5253984937/' .env\r"
        expect "*$*"
        
        # VÃ©rifier la configuration
        send "echo 'ğŸ“‹ Configuration Telegram mise Ã  jour:'\r"
        expect "*$*"
        send "grep TELEGRAM .env\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        
        # TEST IMMÃ‰DIAT 1: Rapport Daznode avec envoi Telegram
        send "echo 'ğŸ¦ TEST ENVOI TELEGRAM - RAPPORT DAZNODE'\r"
        expect "*$*"
        send "echo '=========================================='\r"
        expect "*$*"
        send "./run_report_final.sh scripts/daily_daznode_report.py\r"
        expect "*$*"
        
        # Attendre l'envoi
        sleep 15
        
        send "echo ''\r"
        expect "*$*"
        
        # TEST IMMÃ‰DIAT 2: Rapport SantÃ© App avec envoi Telegram
        send "echo 'ğŸ¥ TEST ENVOI TELEGRAM - RAPPORT SANTÃ‰ APP'\r"
        expect "*$*"
        send "echo '=========================================='\r"
        expect "*$*"
        send "./run_report_final.sh scripts/daily_app_health_report.py\r"
        expect "*$*"
        
        # Attendre l'envoi
        sleep 15
        
        send "echo ''\r"
        expect "*$*"
        
        # VÃ©rifier les logs d'envoi
        send "echo 'ğŸ“Š VÃ‰RIFICATION DES ENVOIS:'\r"
        expect "*$*"
        send "echo '============================'\r"
        expect "*$*"
        
        send "echo 'ğŸ“ DerniÃ¨res lignes log Daznode:'\r"
        expect "*$*"
        send "tail -3 logs/daznode_report.log 2>/dev/null || echo 'Pas encore de log'\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“ DerniÃ¨res lignes log SantÃ© App:'\r"
        expect "*$*"
        send "tail -3 logs/app_health_report.log 2>/dev/null || echo 'Pas encore de log'\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        
        # Confirmer les tÃ¢ches cron
        send "echo 'ğŸ“… TÃ‚CHES CRON ACTIVES:'\r"
        expect "*$*"
        send "echo '========================'\r"
        expect "*$*"
        send "crontab -l | grep -A2 -B1 MCP\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ‰ CONFIGURATION TELEGRAM TERMINÃ‰E !'\r"
        expect "*$*"
        send "echo '===================================='\r"
        expect "*$*"
        send "echo 'ğŸ“± VÃ©rifiez vos messages Telegram !'\r"
        expect "*$*"
        send "echo '   Vous devriez avoir reÃ§u 2 rapports:'\r"
        expect "*$*"
        send "echo '   ğŸ¦ Rapport Daznode (Lightning Network)'\r"
        expect "*$*"
        send "echo '   ğŸ¥ Rapport SantÃ© Application (MCP)'\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        send "echo 'â° Rapports automatiques programmÃ©s:'\r"
        expect "*$*"
        send "echo '   ğŸ“… 7h00 - Rapport Lightning quotidien'\r"
        expect "*$*"
        send "echo '   ğŸ“… 7h05 - Rapport SantÃ© quotidien'\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        send "echo 'âœ… SYSTÃˆME TOTALEMENT OPÃ‰RATIONNEL !'\r"
        expect "*$*"
        
        send "exit\r"
        expect eof
    }
}