#!/usr/bin/expect -f

set timeout 120
set host "147.79.101.32"
set user "root"
set password "Criteria0-Cadmium5-Attempt9-Exit2-Floss1"
set local_config "/Users/stephanecourant/Documents/DAZ/MCP/MCP/config.py"

log_user 1

puts "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘       RÃ‰PARATION API + DÃ‰PLOIEMENT FIX HOST HEADER      â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

# Connexion SSH
puts "\[1/6\] Connexion au serveur..."
spawn ssh -o StrictHostKeyChecking=no $user@$host

expect {
    "password:" { send "$password\r" }
    timeout { puts "\nâŒ Timeout SSH"; exit 1 }
}

expect -re "#"
puts "âœ… ConnectÃ©\n"

# VÃ©rifier l'Ã©tat actuel
puts "\[2/6\] VÃ©rification de l'Ã©tat des conteneurs..."
send "docker ps -a --filter name=mcp --format 'table {{.Names}}\t{{.Status}}'\r"
expect -re "#"
sleep 2

# RÃ©parer MongoDB si nÃ©cessaire
puts "\n\[3/6\] RÃ©paration de MongoDB..."
send "docker restart mcp-mongodb\r"
expect -re "#"
sleep 10

send "docker logs mcp-mongodb --tail=5 2>&1\r"
expect -re "#"
sleep 2

# VÃ©rifier si l'API tourne
puts "\n\[4/6\] VÃ©rification du conteneur mcp-api..."
send "docker ps --filter name=mcp-api --format '{{.Status}}'\r"
expect -re "#"

# DÃ©marrer l'API si elle est arrÃªtÃ©e
puts "\nDÃ©marrage/redÃ©marrage de l'API..."
send "cd /home/feustey/mcp && docker-compose -f docker-compose.hostinger.yml up -d mcp-api 2>&1 | head -20\r"
expect -re "#"
sleep 15

# Maintenant, copier le nouveau config.py dans le conteneur
puts "\n\[5/6\] Copie du nouveau config.py dans le conteneur..."
send "cd /home/feustey/mcp\r"
expect -re "#"

send "docker cp config.py mcp-api:/app/config.py\r"
expect -re "#"
sleep 2

# VÃ©rifier que le fichier a bien Ã©tÃ© copiÃ©
puts "VÃ©rification de la copie..."
send "docker exec mcp-api grep -n 'api.dazno.de' /app/config.py | head -1\r"
expect -re "#"

# RedÃ©marrer l'API pour charger la nouvelle config
puts "\nRedÃ©marrage de l'API avec la nouvelle configuration..."
send "docker restart mcp-api\r"
expect -re "#"
sleep 15

# VÃ©rifications finales
puts "\n\[6/6\] VÃ©rifications finales..."
puts "\n--- Ã‰tat des conteneurs ---"
send "docker ps --filter name=mcp --format 'table {{.Names}}\t{{.Status}}'\r"
expect -re "#"
sleep 2

puts "\n--- Logs de dÃ©marrage (10 derniÃ¨res lignes) ---"
send "docker logs mcp-api --tail=10 2>&1\r"
expect -re "#"
sleep 2

puts "\n--- Test endpoint /health local ---"
send "curl -s http://localhost:8000/health 2>&1 | head -3\r"
expect -re "#"
sleep 2

puts "\n--- Test CRUCIAL /docs (devrait Ãªtre 200 maintenant) ---"
send "curl -sI https://api.dazno.de/docs 2>&1 | head -6\r"
expect -re "#"

puts "\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘                  âœ… RÃ‰PARATION TERMINÃ‰E                 â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts "\nğŸ“‹ Actions effectuÃ©es:"
puts "  âœ… MongoDB redÃ©marrÃ©"
puts "  âœ… API redÃ©marrÃ©e"
puts "  âœ… config.py avec 'api.dazno.de' copiÃ© dans le conteneur"
puts "  âœ… Conteneur mcp-api redÃ©marrÃ© avec nouvelle config"
puts "\nğŸŒ TESTEZ MAINTENANT:"
puts "   ğŸ‘‰ https://api.dazno.de/docs"
puts "\nğŸ’¡ L'erreur 'invalid host header' devrait Ãªtre rÃ©solue !"
puts "   Si vous voyez encore 502, attendez 30-60 secondes.\n"

send "exit\r"
expect eof

exit 0
