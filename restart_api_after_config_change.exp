#!/usr/bin/expect -f

# Script pour redÃ©marrer l'API MCP aprÃ¨s modification de config.py
# Usage: ./restart_api_after_config_change.exp

set timeout 120

# Informations de connexion
set host "srv594809.hstgr.cloud"
set user "u115-pdvfcwqc2ubq"
set password "Feustey@AI!"

log_user 1

puts "\n=== RedÃ©marrage du service MCP API aprÃ¨s modification de config ===="
puts "Connexion au serveur: $host\n"

# Connexion SSH
spawn ssh -o StrictHostKeyChecking=no $user@$host

expect {
    timeout { puts "\nErreur: Timeout lors de la connexion SSH"; exit 1 }
    eof { puts "\nErreur: Connexion SSH fermÃ©e"; exit 1 }
    "password:" {
        send "$password\r"
    }
}

expect {
    timeout { puts "\nErreur: Timeout aprÃ¨s mot de passe"; exit 1 }
    eof { puts "\nErreur: Authentification Ã©chouÃ©e"; exit 1 }
    -re "\\$|#" {
        puts "\nâœ… ConnectÃ© au serveur\n"
    }
}

# Naviguer vers le rÃ©pertoire MCP
puts "Navigation vers le rÃ©pertoire MCP..."
send "cd domains/api.dazno.de/MCP\r"
expect -re "\\$|#"

# VÃ©rifier que le fichier config.py a Ã©tÃ© modifiÃ©
puts "\nVÃ©rification de la modification de config.py..."
send "grep 'api.dazno.de' config.py | head -2\r"
expect -re "\\$|#"

# Rebuild de l'image Docker avec le nouveau config
puts "\nReconstruction de l'image Docker avec la nouvelle config..."
send "docker-compose -f docker-compose.hostinger.yml build mcp-api\r"
expect {
    timeout { puts "\nWarning: Build timeout mais on continue..."; }
    -re "Successfully built" { puts "\nâœ… Image reconstruite avec succÃ¨s" }
    -re "\\$|#" { }
}

# RedÃ©marrer le service mcp-api
puts "\nRedÃ©marrage du conteneur mcp-api..."
send "docker-compose -f docker-compose.hostinger.yml restart mcp-api\r"
expect {
    timeout { puts "\nWarning: Restart timeout" }
    -re "\\$|#" { }
}

sleep 5

# VÃ©rifier le statut du conteneur
puts "\nVÃ©rification du statut des conteneurs..."
send "docker-compose -f docker-compose.hostinger.yml ps mcp-api\r"
expect -re "\\$|#"

# VÃ©rifier les logs rÃ©cents
puts "\nVÃ©rification des logs de dÃ©marrage..."
send "docker-compose -f docker-compose.hostinger.yml logs --tail=20 mcp-api 2>&1 | grep -E '(Configuration|DÃ©marrage|allowed_hosts|TrustedHost)'\r"
expect -re "\\$|#"

# Test du endpoint health
puts "\nTest du endpoint /health..."
send "curl -s http://localhost:8000/health | jq -r '.status' 2>/dev/null || echo 'API non encore prÃªte'\r"
expect -re "\\$|#"

sleep 3

# Test du endpoint docs (celui qui posait problÃ¨me)
puts "\n=== Test du endpoint /docs avec le nouveau host autorisÃ© ==="
send "curl -I https://api.dazno.de/docs 2>&1 | head -5\r"
expect -re "\\$|#"

puts "\n\n=== RÃ©sumÃ© ==="
puts "âœ… Conteneur mcp-api redÃ©marrÃ©"
puts "âœ… Configuration avec api.dazno.de dans allowed_hosts appliquÃ©e"
puts "\nğŸ“ VÃ©rifiez maintenant dans votre navigateur:"
puts "   https://api.dazno.de/docs"
puts "\nSi vous voyez encore 'invalid host header', attendez 30s que le conteneur finisse de dÃ©marrer.\n"

send "exit\r"
expect eof

exit 0
