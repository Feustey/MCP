#!/usr/bin/expect -f

set timeout 60
set host "147.79.101.32"
set user "feustey"
set password "Feustey@AI!"

spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    "*$*" {
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        
        # V√©rifier les fichiers de rapports sur le serveur
        send "echo 'üìä FICHIERS DE RAPPORTS SUR LE SERVEUR:'\r"
        expect "*$*"
        send "echo '========================================'\r"
        expect "*$*"
        send "ls -la scripts/daily_*_report.py\r"
        expect "*$*"
        
        # V√©rifier les dates de modification
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìÖ DATES DE MODIFICATION:'\r"
        expect "*$*"
        send "echo '========================'\r"
        expect "*$*"
        send "stat scripts/daily_daznode_report.py | grep Modify\r"
        expect "*$*"
        send "stat scripts/daily_app_health_report.py | grep Modify\r"
        expect "*$*"
        
        # V√©rifier les tailles de fichiers
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìè TAILLES DES FICHIERS:'\r"
        expect "*$*"
        send "echo '======================='\r"
        expect "*$*"
        send "wc -l scripts/daily_*_report.py\r"
        expect "*$*"
        
        # V√©rifier la configuration actuelle
        send "echo ''\r"
        expect "*$*"
        send "echo '‚öôÔ∏è CONFIGURATION ACTUELLE:'\r"
        expect "*$*"
        send "echo '=========================='\r"
        expect "*$*"
        send "head -5 .env\r"
        expect "*$*"
        
        # V√©rifier les t√¢ches cron
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìÖ T√ÇCHES CRON ACTIVES:'\r"
        expect "*$*"
        send "echo '======================'\r"
        expect "*$*"
        send "crontab -l | grep MCP\r"
        expect "*$*"
        
        # V√©rifier l'environnement virtuel
        send "echo ''\r"
        expect "*$*"
        send "echo 'üêç ENVIRONNEMENT VIRTUEL:'\r"
        expect "*$*"
        send "echo '========================='\r"
        expect "*$*"
        send "source venv_reports/bin/activate && pip list | grep -E '(pydantic|httpx|psutil|redis|numpy)'\r"
        expect "*$*"
        
        # Test rapide de fonctionnement
        send "echo ''\r"
        expect "*$*"
        send "echo 'üß™ TEST RAPIDE DE FONCTIONNEMENT:'\r"
        expect "*$*"
        send "echo '================================='\r"
        expect "*$*"
        send "source venv_reports/bin/activate && python3 -c \"import scripts.daily_daznode_report as d; print('‚úÖ daily_daznode_report importable')\" 2>/dev/null || echo '‚ùå Probl√®me avec daily_daznode_report'\r"
        expect "*$*"
        send "source venv_reports/bin/activate && python3 -c \"import scripts.daily_app_health_report as a; print('‚úÖ daily_app_health_report importable')\" 2>/dev/null || echo '‚ùå Probl√®me avec daily_app_health_report'\r"
        expect "*$*"
        
        send "exit\r"
        expect eof
    }
}