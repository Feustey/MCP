#!/usr/bin/expect -f

set timeout 120
set host "147.79.101.32"
set user "feustey"  
set password "Feustey@AI!"

spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "*password:*" { 
        send "$password\r"
        exp_continue
    }
    "*$*" {
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        
        # Installer les dÃ©pendances manquantes
        send "source venv_reports/bin/activate && pip install pydantic_settings fastapi\r"
        expect "*$*"
        
        # Attendre l'installation
        sleep 10
        
        # Configurer variables d'environnement
        send "echo 'export TELEGRAM_BOT_TOKEN=\"TEST_MODE\"' >> ~/.bashrc\r"
        expect "*$*"
        send "echo 'export TELEGRAM_CHAT_ID=\"TEST_MODE\"' >> ~/.bashrc\r"
        expect "*$*"  
        send "echo 'export API_BASE_URL=\"http://localhost:8000\"' >> ~/.bashrc\r"
        expect "*$*"
        send "source ~/.bashrc\r"
        expect "*$*"
        
        # TEST 1: Rapport Daznode
        send "echo 'ðŸ¦ TEST 1: RAPPORT DAZNODE'\r"
        expect "*$*"
        send "source venv_reports/bin/activate && TELEGRAM_BOT_TOKEN='TEST_MODE' TELEGRAM_CHAT_ID='TEST_MODE' python3 scripts/daily_daznode_report.py\r"
        expect "*$*"
        
        # Attendre
        sleep 10
        
        # TEST 2: Rapport SantÃ© App  
        send "echo 'ðŸ¥ TEST 2: RAPPORT SANTÃ‰ APP'\r"
        expect "*$*"
        send "source venv_reports/bin/activate && TELEGRAM_BOT_TOKEN='TEST_MODE' TELEGRAM_CHAT_ID='TEST_MODE' python3 scripts/daily_app_health_report.py\r"
        expect "*$*"
        
        # Attendre
        sleep 10
        
        # CrÃ©er script d'activation pour cron
        send "cat > run_report.sh << 'EOF'\r"
        expect "*$*"
        send "#!/bin/bash\r"
        expect "*$*" 
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        send "source venv_reports/bin/activate\r"
        expect "*$*"
        send "export TELEGRAM_BOT_TOKEN='YOUR_BOT_TOKEN'\r"
        expect "*$*"
        send "export TELEGRAM_CHAT_ID='YOUR_CHAT_ID'\r"
        expect "*$*"
        send "python3 \\$1\r"
        expect "*$*"
        send "EOF\r"
        expect "*$*"
        
        send "chmod +x run_report.sh\r"
        expect "*$*"
        
        # Installer les tÃ¢ches cron
        send "echo 'ðŸ“… INSTALLATION CRON'\r"
        expect "*$*"
        send "(crontab -l 2>/dev/null; echo '0 7 * * * /home/feustey/MCP/run_report.sh scripts/daily_daznode_report.py >> logs/daznode_report.log 2>&1'; echo '5 7 * * * /home/feustey/MCP/run_report.sh scripts/daily_app_health_report.py >> logs/app_health_report.log 2>&1') | crontab -\r"
        expect "*$*"
        
        # VÃ©rifier
        send "crontab -l | tail -3\r"
        expect "*$*"
        
        send "echo 'âœ… DÃ‰PLOIEMENT TERMINÃ‰ - RAPPORTS PRÃŠTS !'\r"
        expect "*$*"
        
        send "exit\r"
        expect eof
    }
}