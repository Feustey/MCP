#!/usr/bin/expect -f

################################################################################
# Script de DÃ©ploiement Autonome avec Gestion Mot de Passe
#
# Ce script gÃ¨re le dÃ©ploiement complet avec authentification sudo
#
# Usage: ./deploy_autonomous_expect.exp [sudo_password]
#
# Auteur: MCP Team
# Date: 13 octobre 2025
################################################################################

set timeout -1

# Configuration
set SSH_USER "feustey"
set SSH_HOST "147.79.101.32"
set DEPLOY_DIR "/home/feustey/mcp-production"

# RÃ©cupÃ©rer le mot de passe sudo (ou demander)
if {$argc > 0} {
    set SUDO_PASSWORD [lindex $argv 0]
} else {
    puts "\nğŸ” Mot de passe sudo pour feustey@147.79.101.32:"
    stty -echo
    expect_user -re "(.*)\n"
    set SUDO_PASSWORD $expect_out(1,string)
    stty echo
    puts ""
}

# GÃ©nÃ©rer les secrets
set MONGODB_PASSWORD [exec openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 32]
set REDIS_PASSWORD [exec openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 32]
set SECRET_KEY [exec openssl rand -base64 32 | tr -d '\n']
set ENCRYPTION_KEY [exec openssl rand -base64 32]

puts "\n\033\[1m\033\[0;36m"
puts "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘                                                           â•‘"
puts "â•‘     MCP v1.0 - DÃ©ploiement Autonome Complet              â•‘"
puts "â•‘     Lightning Network Channel Optimizer                   â•‘"
puts "â•‘                                                           â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts "\033\[0m\n"

puts "ğŸŒ Serveur: $SSH_USER@$SSH_HOST"
puts "ğŸ“ RÃ©pertoire: $DEPLOY_DIR\n"

# Ã‰tape 1: VÃ©rification connexion
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 1/7 : VÃ©rification de la connexion SSH"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

spawn ssh -o ConnectTimeout=10 $SSH_USER@$SSH_HOST "echo 'Connection OK'"
expect {
    "Connection OK" {
        puts "âœ“ Connexion SSH Ã©tablie\n"
    }
    timeout {
        puts "âœ— Timeout de connexion\n"
        exit 1
    }
    eof
}

# Ã‰tape 2: Transfert des fichiers
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 2/7 : Transfert des fichiers"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

# CrÃ©er la structure
spawn ssh $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_DIR/\{app,src,config,scripts,logs,data,ssl,backups/mongodb\}"
expect eof

puts "âœ“ Structure crÃ©Ã©e\n"

# TransfÃ©rer les fichiers
set files {docker-compose.hostinger.yml Dockerfile.production mongo-init.js nginx-docker.conf docker_entrypoint.sh start_api.sh requirements-production.txt}

foreach file $files {
    puts "Transfert: $file"
    spawn scp -q $file $SSH_USER@$SSH_HOST:$DEPLOY_DIR/
    expect eof
}

# TransfÃ©rer les rÃ©pertoires
set dirs {app src config scripts auth}
foreach dir $dirs {
    puts "Synchronisation: $dir/"
    spawn rsync -az --delete $dir/ $SSH_USER@$SSH_HOST:$DEPLOY_DIR/$dir/
    expect eof
}

puts "\nâœ“ Tous les fichiers transfÃ©rÃ©s\n"

# Ã‰tape 3: Configuration .env
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 3/7 : Configuration de l'environnement"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

set env_content "
ENVIRONMENT=production
DEBUG=false
DRY_RUN=true

API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=2

MONGODB_USER=mcpuser
MONGODB_PASSWORD=$MONGODB_PASSWORD
MONGODB_DATABASE=mcp_prod
MONGODB_URI=mongodb://mcpuser:$MONGODB_PASSWORD@mongodb:27017/mcp_prod?authSource=admin

REDIS_PASSWORD=$REDIS_PASSWORD
REDIS_URL=redis://:$REDIS_PASSWORD@redis:6379/0

SECRET_KEY=$SECRET_KEY
ENCRYPTION_KEY=$ENCRYPTION_KEY

LNBITS_URL=https://your-lnbits-instance.com
LNBITS_ADMIN_KEY=your_admin_key
LNBITS_INVOICE_KEY=your_invoice_key

ENABLE_SHADOW_MODE=true
ENABLE_RAG=false
MAX_CHANGES_PER_DAY=5
REQUIRE_MANUAL_APPROVAL=true
REDIS_TTL_NODE_DATA=300
REDIS_TTL_CHANNEL_DATA=600
LOG_LEVEL=INFO
STRUCTLOG_ENABLED=true
"

spawn ssh $SSH_USER@$SSH_HOST "cat > $DEPLOY_DIR/.env"
send "$env_content"
send "\x04"
expect eof

puts "âœ“ Fichier .env crÃ©Ã© avec secrets sÃ©curisÃ©s\n"

# Ã‰tape 4: Permissions
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 4/7 : Configuration des permissions"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && chmod +x docker_entrypoint.sh start_api.sh scripts/*.sh"
expect eof

puts "âœ“ Permissions configurÃ©es\n"

# Ã‰tape 5: ArrÃªt containers existants
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 5/7 : Nettoyage des containers existants"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && sudo docker-compose -f docker-compose.hostinger.yml down"
expect {
    -re ".*password.*:" {
        send "$SUDO_PASSWORD\r"
        exp_continue
    }
    eof
}

puts "âœ“ Nettoyage effectuÃ©\n"

# Ã‰tape 6: Construction des images
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 6/7 : Construction des images Docker"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

puts "â³ Construction en cours (cela peut prendre 5-10 minutes)...\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && sudo docker-compose -f docker-compose.hostinger.yml build --no-cache"
expect {
    -re ".*password.*:" {
        send "$SUDO_PASSWORD\r"
        exp_continue
    }
    "Successfully built" {
        exp_continue
    }
    "Successfully tagged" {
        exp_continue
    }
    eof
}

puts "\nâœ“ Images Docker construites\n"

# Ã‰tape 7: DÃ©marrage des services
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸš€ Ã‰tape 7/7 : DÃ©marrage des services"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && sudo docker-compose -f docker-compose.hostinger.yml up -d"
expect {
    -re ".*password.*:" {
        send "$SUDO_PASSWORD\r"
        exp_continue
    }
    "Started" {
        exp_continue
    }
    eof
}

puts "\nâœ“ Services dÃ©marrÃ©s\n"

puts "â³ Attente de la stabilisation (60 secondes)...\n"
sleep 60

# Validation
puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸ§ª Validation du dÃ©ploiement"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

# Test MongoDB
spawn ssh $SSH_USER@$SSH_HOST "sudo docker exec mcp-mongodb mongosh -u mcpuser -p $MONGODB_PASSWORD --authenticationDatabase admin --eval 'db.runCommand(\"ping\")' --quiet"
expect {
    -re ".*password.*:" {
        send "$SUDO_PASSWORD\r"
        exp_continue
    }
    -re ".*ok.*1.*" {
        puts "âœ“ MongoDB opÃ©rationnel"
    }
    timeout {
        puts "âš  MongoDB ne rÃ©pond pas encore"
    }
    eof
}

# Test Redis
spawn ssh $SSH_USER@$SSH_HOST "sudo docker exec mcp-redis redis-cli -a $REDIS_PASSWORD ping"
expect {
    -re ".*password.*:" {
        send "$SUDO_PASSWORD\r"
        exp_continue
    }
    "PONG" {
        puts "âœ“ Redis opÃ©rationnel"
    }
    timeout {
        puts "âš  Redis ne rÃ©pond pas encore"
    }
    eof
}

sleep 10

# Test API
spawn ssh $SSH_USER@$SSH_HOST "curl -sf http://localhost:8000/ -m 5"
expect {
    -re ".*healthy.*" {
        puts "âœ“ API MCP opÃ©rationnelle"
    }
    timeout {
        puts "âš  API ne rÃ©pond pas encore (peut prendre 2-3 minutes)"
    }
    eof
}

# Test Nginx
spawn ssh $SSH_USER@$SSH_HOST "curl -sf http://localhost/ -m 5"
expect {
    -re ".*" {
        puts "âœ“ Nginx opÃ©rationnel"
    }
    timeout {
        puts "âš  Nginx ne rÃ©pond pas encore"
    }
    eof
}

# RÃ©sumÃ© final
puts "\n\n"
puts "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘                                                            â•‘"
puts "â•‘     âœ… DÃ‰PLOIEMENT AUTONOME TERMINÃ‰ AVEC SUCCÃˆS !         â•‘"
puts "â•‘                                                            â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

puts "ğŸ“Š Informations de DÃ©ploiement"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "ğŸŒ Serveur:           $SSH_HOST"
puts "ğŸ“ RÃ©pertoire:        $DEPLOY_DIR"
puts "ğŸ” MongoDB User:      mcpuser"
puts "ğŸ—„ï¸  Database:          mcp_prod"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

puts "ğŸ”— URLs d'AccÃ¨s"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
puts "API (HTTP):  http://147.79.101.32:8000"
puts "Web (HTTP):  http://147.79.101.32"
puts "Docs API:    http://147.79.101.32:8000/docs"
puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

# Sauvegarder les credentials
set creds_file [open "DEPLOYMENT_CREDENTIALS.txt" w]
puts $creds_file "# MCP v1.0 - Credentials de DÃ©ploiement"
puts $creds_file "# Date: [exec date]"
puts $creds_file "#"
puts $creds_file "# âš ï¸  FICHIER SENSIBLE - NE PAS COMMITTER âš ï¸\n"
puts $creds_file "Serveur: $SSH_HOST"
puts $creds_file "Utilisateur: $SSH_USER"
puts $creds_file "RÃ©pertoire: $DEPLOY_DIR\n"
puts $creds_file "MongoDB:"
puts $creds_file "  User: mcpuser"
puts $creds_file "  Password: $MONGODB_PASSWORD"
puts $creds_file "  Database: mcp_prod"
puts $creds_file "  Connection: mongodb://mcpuser:$MONGODB_PASSWORD@mongodb:27017/mcp_prod?authSource=admin\n"
puts $creds_file "Redis:"
puts $creds_file "  Password: $REDIS_PASSWORD"
puts $creds_file "  Connection: redis://:$REDIS_PASSWORD@redis:6379/0\n"
puts $creds_file "Security:"
puts $creds_file "  Secret Key: $SECRET_KEY"
puts $creds_file "  Encryption Key: $ENCRYPTION_KEY\n"
puts $creds_file "URLs:"
puts $creds_file "  API: http://147.79.101.32:8000"
puts $creds_file "  Docs: http://147.79.101.32:8000/docs"
puts $creds_file "  Web: http://147.79.101.32"
close $creds_file

puts "âœ“ Credentials sauvegardÃ©s dans DEPLOYMENT_CREDENTIALS.txt"
puts "âš ï¸  IMPORTANT : Ne pas committer DEPLOYMENT_CREDENTIALS.txt !\n"

puts "ğŸ‰ DÃ©ploiement terminÃ© ! MCP v1.0 est opÃ©rationnel sur Hostinger !\n"

exit 0

