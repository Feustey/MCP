#!/usr/bin/expect -f

set timeout 120
set host "147.79.101.32"
set user "feustey"
set password "Feustey@AI!"

spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    "*$*" {
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        
        send "echo 'ğŸ”§ CORRECTION DES TÃ‚CHES CRON MANQUANTES'\r"
        expect "*$*"
        send "echo '========================================'\r"
        expect "*$*"
        
        # VÃ©rifier le crontab actuel
        send "echo 'ğŸ“‹ Crontab actuel:'\r"
        expect "*$*"
        send "crontab -l 2>/dev/null || echo 'Aucune tÃ¢che cron configurÃ©e'\r"
        expect "*$*"
        
        # Installer les tÃ¢ches cron pour les rapports MCP
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“… Installation des tÃ¢ches cron MCP...'\r"
        expect "*$*"
        send "(crontab -l 2>/dev/null; echo ''; echo '# Rapports quotidiens MCP - 7h00 et 7h05'; echo '0 7 * * * /home/feustey/MCP/run_report_final.sh scripts/daily_daznode_report.py >> /home/feustey/MCP/logs/daznode_report.log 2>&1'; echo '5 7 * * * /home/feustey/MCP/run_report_final.sh scripts/daily_app_health_report.py >> /home/feustey/MCP/logs/app_health_report.log 2>&1') | crontab -\r"
        expect "*$*"
        
        # VÃ©rifier que les tÃ¢ches sont bien installÃ©es
        send "echo ''\r"
        expect "*$*"
        send "echo 'âœ… VÃ©rification des tÃ¢ches installÃ©es:'\r"
        expect "*$*"
        send "crontab -l | grep -A3 -B1 MCP\r"
        expect "*$*"
        
        # VÃ©rifier que le script d'exÃ©cution existe et est exÃ©cutable
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ” VÃ©rification du script d\\'exÃ©cution:'\r"
        expect "*$*"
        send "ls -la run_report_final.sh\r"
        expect "*$*"
        
        # CrÃ©er le rÃ©pertoire logs s'il n'existe pas
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“ VÃ©rification du rÃ©pertoire logs:'\r"
        expect "*$*"
        send "mkdir -p logs\r"
        expect "*$*"
        send "ls -la logs/\r"
        expect "*$*"
        
        # TEST FINAL COMPLET
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ§ª TEST FINAL COMPLET DES RAPPORTS'\r"
        expect "*$*"
        send "echo '=================================='\r"
        expect "*$*"
        
        # Test 1: Rapport Daznode
        send "echo 'ğŸ¦ Test Rapport Daznode avec envoi Telegram...'\r"
        expect "*$*"
        send "./run_report_final.sh scripts/daily_daznode_report.py\r"
        expect "*$*"
        
        # Attendre l'exÃ©cution
        sleep 15
        
        # Test 2: Rapport SantÃ© App
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ¥ Test Rapport SantÃ© App avec envoi Telegram...'\r"
        expect "*$*"
        send "./run_report_final.sh scripts/daily_app_health_report.py\r"
        expect "*$*"
        
        # Attendre l'exÃ©cution
        sleep 15
        
        # VÃ©rifier les logs
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“Š RÃ‰SULTATS DES TESTS:'\r"
        expect "*$*"
        send "echo '======================='\r"
        expect "*$*"
        
        send "echo 'ğŸ“ DerniÃ¨res lignes log Daznode:'\r"
        expect "*$*"
        send "tail -3 logs/daznode_report.log 2>/dev/null || echo 'Pas encore de log Daznode'\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“ DerniÃ¨res lignes log SantÃ© App:'\r"
        expect "*$*"
        send "tail -3 logs/app_health_report.log 2>/dev/null || echo 'Pas encore de log SantÃ© App'\r"
        expect "*$*"
        
        # RÃ©sumÃ© final
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ‰ VÃ‰RIFICATION ET CORRECTION TERMINÃ‰ES !'\r"
        expect "*$*"
        send "echo '========================================='\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        send "echo 'âœ… Ã‰TAT FINAL DU SYSTÃˆME:'\r"
        expect "*$*"
        send "echo '  ğŸ“Š Scripts: daily_daznode_report.py (348 lignes)'\r"
        expect "*$*"
        send "echo '  ğŸ“Š Scripts: daily_app_health_report.py (467 lignes)'\r"
        expect "*$*"
        send "echo '  âš™ï¸  Configuration: .env avec tokens Telegram'\r"
        expect "*$*"
        send "echo '  ğŸ Environnement: venv_reports avec toutes dÃ©pendances'\r"
        expect "*$*"
        send "echo '  ğŸ“… Cron: TÃ¢ches installÃ©es pour 7h00 et 7h05'\r"
        expect "*$*"
        send "echo '  ğŸ“± Telegram: Tests d\\'envoi effectuÃ©s'\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ¯ RAPPORTS AUTOMATIQUES ACTIFS:'\r"
        expect "*$*"
        send "echo '  ğŸ¦ 7h00 - Rapport Lightning Network quotidien'\r"
        expect "*$*"
        send "echo '  ğŸ¥ 7h05 - Rapport SantÃ© Application quotidien'\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        send "echo 'ğŸ“± VÃ©rifiez vos messages Telegram !'\r"
        expect "*$*"
        
        send "exit\r"
        expect eof
    }
}