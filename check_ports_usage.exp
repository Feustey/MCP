#!/usr/bin/expect -f

set timeout 20
spawn ssh root@147.79.101.32

expect "*password:*"
send "Criteria0-Cadmium5-Attempt9-Exit2-Floss1\r"

expect "*#*"
send "echo 'ðŸ” VÃ‰RIFICATION UTILISATION DES PORTS'\r"

expect "*#*"
send "echo '===================================='\r"

expect "*#*"
send "echo '1. Tous les ports en Ã©coute:'\r"

expect "*#*"
send "netstat -tlnp | grep -E ':(80|8080|443|8443|3000)'\r"

expect "*#*"
send "echo ''\r"

expect "*#*"
send "echo '2. Processus Docker sur ces ports:'\r"

expect "*#*"
send "docker ps --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'\r"

expect "*#*"
send "echo ''\r"

expect "*#*"
send "echo '3. DÃ©tail Grafana (port 3000):'\r"

expect "*#*"
send "docker port mcp-grafana 2>/dev/null || echo 'Grafana non trouvÃ©'\r"

expect "*#*"
send "echo ''\r"

expect "*#*"
send "echo '4. Test accÃ¨s Grafana:'\r"

expect "*#*"
send "curl -s -o /dev/null -w 'Grafana localhost:3000: %{http_code}' http://localhost:3000 && echo\r"

expect "*#*"
send "echo ''\r"

expect "*#*"
send "echo '5. Conflit potentiel Token4Good:'\r"

expect "*#*"
send "docker ps | grep t4g\r"

expect "*#*"
send "echo ''\r"

expect "*#*"
send "echo '6. Qui utilise le port 80 exactement:'\r"

expect "*#*"
send "lsof -i :80 2>/dev/null || echo 'Port 80 libre ou non accessible'\r"

expect "*#*"
send "exit\r"

expect eof