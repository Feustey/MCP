#!/usr/bin/expect -f

set timeout -1
set SSH_USER "feustey"
set SSH_HOST "147.79.101.32"
set DEPLOY_DIR "/home/feustey/mcp-production"
set SUDO_PASSWORD "Criteria0-Cadmium5-Attempt9-Exit2-Floss1"

puts "\nüîß Finalisation du d√©ploiement...\n"

# V√©rifier l'√©tat actuel
puts "üìä V√©rification de l'√©tat des containers...\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && echo '$SUDO_PASSWORD' | sudo -S docker-compose -f docker-compose.hostinger.yml ps"
expect eof

# Red√©marrer tous les services
puts "\nüîÑ Red√©marrage complet des services...\n"

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && echo '$SUDO_PASSWORD' | sudo -S docker-compose -f docker-compose.hostinger.yml down"
expect eof

spawn ssh $SSH_USER@$SSH_HOST "cd $DEPLOY_DIR && echo '$SUDO_PASSWORD' | sudo -S docker-compose -f docker-compose.hostinger.yml up -d"
expect eof

puts "\n‚è≥ Attente de stabilisation (60 secondes)...\n"
sleep 60

# Validation finale
puts "\nüß™ Validation finale...\n"

spawn ssh $SSH_USER@$SSH_HOST "echo '$SUDO_PASSWORD' | sudo -S docker ps --format 'table {{.Names}}\t{{.Status}}'"
expect eof

# Test MongoDB
spawn ssh $SSH_USER@$SSH_HOST "echo '$SUDO_PASSWORD' | sudo -S docker exec mcp-mongodb mongosh -u mcpuser -p xlW25UUklgnZ1ib2ENsxQVwNqG31FBhX --authenticationDatabase admin --eval 'db.runCommand(\"ping\")' --quiet"
expect {
    -re ".*ok.*1.*" {
        puts "\n‚úì MongoDB op√©rationnel\n"
    }
    timeout {
        puts "\n‚ö† MongoDB pas encore pr√™t\n"
    }
    eof
}

# Test Redis
spawn ssh $SSH_USER@$SSH_HOST "echo '$SUDO_PASSWORD' | sudo -S docker exec mcp-redis redis-cli -a HgHIvAIoJZ3E2pfnswXOBBbQE7T8GJD5 ping"
expect {
    "PONG" {
        puts "‚úì Redis op√©rationnel\n"
    }
    timeout {
        puts "‚ö† Redis pas encore pr√™t\n"
    }
    eof
}

# Test API
spawn ssh $SSH_USER@$SSH_HOST "curl -sf http://localhost:8000/api/v1/health -m 5"
expect {
    -re ".*healthy.*" {
        puts "‚úì API op√©rationnelle\n"
    }
    timeout {
        puts "‚ö† API pas encore pr√™te\n"
    }
    eof
}

puts "\n‚úÖ Finalisation termin√©e !\n"
puts "üåê Acc√®s: http://147.79.101.32:8000\n"

exit 0

