#!/usr/bin/expect -f

set timeout 60
spawn ssh feustey@147.79.101.32

expect "*password:*"
send "Feustey@AI!\r"

expect "*$*"
send "cd /home/feustey/MCP\r"

expect "*$*" 
send "echo 'ðŸ” INVESTIGATION APPROFONDIE API'\r"

expect "*$*"
send "echo '================================'\r"

expect "*$*"
send "echo '1. Logs API (erreurs rÃ©centes):'\r"

expect "*$*"
send "docker logs mcp-api --tail=20 2>&1 | grep -E '(ERROR|error|Error|Exception|500)' || echo 'Pas d erreurs dans logs API'\r"

expect "*$*"
send "echo ''\r"

expect "*$*"
send "echo '2. Logs Nginx dÃ©taillÃ©s:'\r"

expect "*$*"
send "docker logs mcp-nginx --tail=20 2>&1\r"

expect "*$*"
send "echo ''\r"

expect "*$*"
send "echo '3. Configuration rÃ©seau Docker:'\r"

expect "*$*"
send "docker network ls\r"

expect "*$*"
send "docker inspect mcp-api | grep -A 10 'NetworkSettings'\r"

expect "*$*"
send "echo ''\r"

expect "*$*"
send "echo '4. Test connectivitÃ© entre conteneurs:'\r"

expect "*$*"
send "docker exec mcp-nginx wget -qO- --timeout=5 http://mcp-api:8000/health 2>&1 || echo 'Connexion mcp-nginx -> mcp-api FAILED'\r"

expect "*$*"
send "echo ''\r"

expect "*$*"
send "echo '5. Ã‰tat des ports et processus API:'\r"

expect "*$*"
send "docker exec mcp-api netstat -tlnp | grep :8000 || echo 'Port 8000 non ouvert dans le conteneur'\r"

expect "*$*"
send "echo ''\r"

expect "*$*"
send "echo '6. Test direct conteneur -> conteneur:'\r"

expect "*$*"
send "API_IP=\\$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mcp-api) && echo \"IP API: \\$API_IP\"\r"

expect "*$*"
send "docker exec mcp-nginx wget -qO- --timeout=5 http://\\$API_IP:8000/health 2>&1 || echo 'Connexion directe IP FAILED'\r"

expect "*$*"
send "exit\r"

expect eof