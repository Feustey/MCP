# Docker Compose Production MCP Lightning
# Configuration optimisée pour Hostinger
# Dernière mise à jour: 30 septembre 2025

version: '3.8'

services:
  # Service principal MCP
  mcp-api:
    image: feustey/mcp-dazno:latest
    container_name: mcp-api
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Configuration Python
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app:/app/src
    volumes:
      - ./mcp-data/logs:/app/logs
      - ./mcp-data/data:/app/data
      - ./src:/app/src:ro
      - ./app:/app/app:ro
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s
    depends_on:
      - qdrant

  # Reverse proxy Nginx
  nginx:
    image: nginx:alpine
    container_name: mcp-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/simple.conf:/etc/nginx/conf.d/default.conf:ro
      - ./mcp-data/logs/nginx:/var/log/nginx
    depends_on:
      - mcp-api
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Base vectorielle Qdrant
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: mcp-qdrant
    restart: always
    expose:
      - "6333"
      - "6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__SERVICE__MAX_REQUEST_SIZE_MB=100
      - QDRANT__SERVICE__MAX_WORKERS=4
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - mcp-network

  # Service de monitoring
  monitoring:
    image: alpine:3.18
    container_name: mcp-monitoring
    restart: always
    depends_on:
      - mcp-api
      - qdrant
    environment:
      - CHECK_INTERVAL=30
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    networks:
      - mcp-network
    command: >
      sh -c "
        apk add --no-cache wget &&
        echo 'Monitoring service started' &&
        while true; do
          echo '[$(date)] Health check cycle...'
          wget -q --spider http://mcp-api:8000/health && echo 'API: OK' || echo 'API: FAILED'
          wget -q --spider http://qdrant:6333/health && echo 'Qdrant: OK' || echo 'Qdrant: FAILED'
          sleep $${CHECK_INTERVAL:-30}
        done
      "

volumes:
  qdrant_data:
    driver: local
    name: mcp_qdrant_data

networks:
  mcp-network:
    driver: bridge
    name: mcp_network
