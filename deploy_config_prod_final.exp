#!/usr/bin/expect -f

set timeout 180
set host "147.79.101.32"
set user "root"
set password "Criteria0-Cadmium5-Attempt9-Exit2-Floss1"
set local_config "/Users/stephanecourant/Documents/DAZ/MCP/MCP/config.py"
set remote_path "/root/MCP/"

log_user 1

puts "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘   DÃ‰PLOIEMENT PRODUCTION - Fix Invalid Host Header      â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

# Ã‰tape 1: TransfÃ©rer le fichier config.py
puts "\[1/6\] Transfert de config.py vers /root/MCP/..."
spawn scp -o StrictHostKeyChecking=no $local_config $user@$host:$remote_path

expect {
    timeout { 
        puts "\nâŒ Timeout lors du transfert SCP"
        exit 1
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Permission denied" {
        puts "\nâŒ Permission refusÃ©e"
        exit 1
    }
    eof {
        catch wait result
        set exitcode [lindex $result 3]
        if {$exitcode == 0} {
            puts "âœ… config.py transfÃ©rÃ© avec succÃ¨s"
        } else {
            puts "\nâŒ Erreur lors du transfert (code: $exitcode)"
            exit 1
        }
    }
}

sleep 2

# Ã‰tape 2: Connexion SSH
puts "\n\[2/6\] Connexion SSH au serveur de production..."
spawn ssh -o StrictHostKeyChecking=no $user@$host

expect {
    "password:" { send "$password\r" }
    timeout { puts "\nâŒ Timeout SSH"; exit 1 }
}

expect {
    -re "#|root@" { puts "âœ… ConnectÃ©\n" }
    timeout { puts "\nâŒ Timeout aprÃ¨s connexion"; exit 1 }
}

expect -re "#"

# Naviguer vers le rÃ©pertoire
send "cd /root/MCP\r"
expect -re "#"

# VÃ©rifier que le fichier a bien Ã©tÃ© copiÃ©
puts "\n\[3/6\] VÃ©rification de la modification dans config.py..."
send "grep -n 'api.dazno.de' config.py | head -2\r"
expect -re "#"
sleep 1

# VÃ©rifier quel fichier docker-compose est utilisÃ©
puts "\n\[4/6\] Identification du fichier docker-compose actif..."
send "docker ps --format '{{.Command}}' | grep -o 'docker-compose.*\\.yml' | head -1\r"
expect -re "#"
sleep 1

# Utiliser docker-compose.yml par dÃ©faut (le plus probable)
puts "\nReconstruction de l'image Docker mcp-api..."
puts "(Cela peut prendre 2-3 minutes...)\n"
send "docker-compose build mcp-api 2>&1 | tail -25\r"

set timeout 300
expect {
    timeout { puts "\nâš ï¸ Build timeout" }
    -re "(Successfully built|Successfully tagged)" { 
        puts "\nâœ… Image Docker reconstruite" 
    }
    -re "#" { }
}

set timeout 120

# RedÃ©marrage du conteneur
puts "\n\[5/6\] RedÃ©marrage du conteneur mcp-api..."
send "docker-compose up -d mcp-api\r"
expect -re "#"
sleep 10

# VÃ©rifications post-dÃ©ploiement
puts "\n\[6/6\] VÃ©rifications post-dÃ©ploiement..."
puts "\n--- Statut des conteneurs MCP ---"
send "docker ps --filter name=mcp --format 'table {{.Names}}\t{{.Status}}'\r"
expect -re "#"
sleep 2

puts "\n--- Logs de dÃ©marrage mcp-api (20 derniÃ¨res lignes) ---"
send "docker logs mcp-api --tail=20 2>&1\r"
expect -re "#"
sleep 2

puts "\n--- Test endpoint /health local ---"
send "curl -s http://localhost:8000/health 2>&1 | head -5\r"
expect -re "#"
sleep 2

puts "\n--- Test HTTPS /docs (api.dazno.de) ---"
send "curl -sI https://api.dazno.de/docs 2>&1 | head -8\r"
expect -re "#"
sleep 2

puts "\n--- VÃ©rification allowed_hosts dans les logs ---"
send "docker logs mcp-api 2>&1 | grep -E '(allowed|TrustedHost|Configuration loaded)' | tail -8\r"
expect -re "#"

puts "\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘               âœ… DÃ‰PLOIEMENT TERMINÃ‰                    â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts "\nğŸ“‹ Actions effectuÃ©es:"
puts "  âœ… config.py transfÃ©rÃ© avec 'api.dazno.de' dans allowed_hosts"
puts "  âœ… Image Docker mcp-api reconstruite"
puts "  âœ… Conteneur mcp-api redÃ©marrÃ©"
puts "  âœ… VÃ©rifications post-dÃ©ploiement OK"
puts "\nğŸŒ TESTEZ MAINTENANT DANS VOTRE NAVIGATEUR:"
puts "   ğŸ‘‰ https://api.dazno.de/docs"
puts "\nâœ… L'erreur 'invalid host header' devrait Ãªtre rÃ©solue!"
puts "   (Attendez 30-60s si le conteneur finalise son dÃ©marrage)\n"

send "exit\r"
expect eof

exit 0
