#!/usr/bin/expect -f

set timeout 120
set host "147.79.101.32"
set user "feustey"
set password "Feustey@AI!"

spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "*password:*" {
        send "$password\r"
        exp_continue
    }
    "*$*" {
        send "cd /home/feustey/MCP\r"
        expect "*$*"
        
        send "echo 'üîç V√âRIFICATION COMPL√àTE DE LA PRODUCTION'\r"
        expect "*$*"
        send "echo '========================================='\r"
        expect "*$*"
        send "echo ''\r"
        expect "*$*"
        
        # V√©rifier les services Docker
        send "echo 'üê≥ √âTAT DES SERVICES DOCKER:'\r"
        expect "*$*"
        send "echo '============================'\r"
        expect "*$*"
        send "docker ps -a\r"
        expect "*$*"
        
        # V√©rifier sp√©cifiquement les services MCP
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìä SERVICES MCP:'\r"
        expect "*$*"
        send "echo '================'\r"
        expect "*$*"
        send "docker ps | grep -E '(mcp|api|redis|mongo)' || echo '‚ùå Aucun service MCP en cours d\\'ex√©cution'\r"
        expect "*$*"
        
        # Test des endpoints API principaux
        send "echo ''\r"
        expect "*$*"
        send "echo 'üîó TEST DES ENDPOINTS API:'\r"
        expect "*$*"
        send "echo '========================='\r"
        expect "*$*"
        
        # Test endpoint sant√©
        send "echo '1. Health Check:'\r"
        expect "*$*"
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/health && echo ' ‚úÖ' || echo ' ‚ùå'\r"
        expect "*$*"
        
        # Test endpoint sant√© d√©taill√©e
        send "echo '2. Health Detailed:'\r"
        expect "*$*"
        send "curl -s http://localhost:8000/health/detailed | head -10 || echo '‚ùå API non accessible'\r"
        expect "*$*"
        
        # Test endpoint m√©triques
        send "echo '3. Metrics:'\r"
        expect "*$*"
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/metrics && echo ' ‚úÖ' || echo ' ‚ùå'\r"
        expect "*$*"
        
        # Test endpoint docs
        send "echo '4. API Docs:'\r"
        expect "*$*"
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/docs && echo ' ‚úÖ' || echo ' ‚ùå'\r"
        expect "*$*"
        
        # V√©rifier les ports
        send "echo ''\r"
        expect "*$*"
        send "echo 'üîå PORTS OUVERTS:'\r"
        expect "*$*"
        send "echo '=================='\r"
        expect "*$*"
        send "netstat -tuln | grep -E '(8000|6379|27017|5000)' || ss -tuln | grep -E '(8000|6379|27017|5000)'\r"
        expect "*$*"
        
        # V√©rifier les logs r√©cents
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìù LOGS R√âCENTS:'\r"
        expect "*$*"
        send "echo '================'\r"
        expect "*$*"
        send "docker logs --tail 10 mcp-api 2>&1 | head -10 || echo 'Pas de logs API'\r"
        expect "*$*"
        
        # V√©rifier l'espace disque
        send "echo ''\r"
        expect "*$*"
        send "echo 'üíæ ESPACE DISQUE:'\r"
        expect "*$*"
        send "echo '=================='\r"
        expect "*$*"
        send "df -h | grep -E '(\\/$|/home)'\r"
        expect "*$*"
        
        # V√©rifier les processus Python
        send "echo ''\r"
        expect "*$*"
        send "echo 'üêç PROCESSUS PYTHON:'\r"
        expect "*$*"
        send "echo '====================='\r"
        expect "*$*"
        send "ps aux | grep -E '(python|uvicorn)' | grep -v grep | head -5\r"
        expect "*$*"
        
        # V√©rifier docker-compose
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìã CONFIGURATION DOCKER-COMPOSE:'\r"
        expect "*$*"
        send "echo '================================='\r"
        expect "*$*"
        send "ls -la docker-compose*.yml 2>/dev/null || ls -la compose*.yml 2>/dev/null || echo 'Pas de fichier docker-compose trouv√©'\r"
        expect "*$*"
        
        # Test complet avec les rapports
        send "echo ''\r"
        expect "*$*"
        send "echo 'üß™ TEST RAPIDE DES RAPPORTS:'\r"
        expect "*$*"
        send "echo '============================='\r"
        expect "*$*"
        send "source venv_reports/bin/activate && python3 -c \"print('‚úÖ Environnement Python OK')\" || echo '‚ùå Probl√®me environnement Python'\r"
        expect "*$*"
        
        send "echo ''\r"
        expect "*$*"
        send "echo 'üìä R√âSUM√â DE L\\'√âTAT:'\r"
        expect "*$*"
        send "echo '====================='\r"
        expect "*$*"
        send "echo 'V√©rifiez les r√©sultats ci-dessus pour:'\r"
        expect "*$*"
        send "echo '- Services Docker actifs'\r"
        expect "*$*"
        send "echo '- API r√©pondant sur le port 8000'\r"
        expect "*$*"
        send "echo '- Services auxiliaires (Redis, MongoDB)'\r"
        expect "*$*"
        send "echo '- Espace disque disponible'\r"
        expect "*$*"
        
        send "exit\r"
        expect eof
    }
}