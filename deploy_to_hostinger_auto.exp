#!/usr/bin/expect -f

################################################################################
# Script de DÃ©ploiement AutomatisÃ© MCP sur Hostinger
# 
# Ce script automatise complÃ¨tement le dÃ©ploiement sur le serveur distant
#
# Usage: ./deploy_to_hostinger_auto.exp
################################################################################

set timeout -1
set server "147.79.101.32"
set user "root"
set password "Criteria0-Cadmium5-Attempt9-Exit2-Floss1"
set local_dir "/Users/stephanecourant/Documents/DAZ/MCP/MCP"

# Colors
proc print_header {text} {
    puts "\033\[1;36m"
    puts "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    puts "â•‘  $text"
    puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    puts "\033\[0m"
}

proc print_step {text} {
    puts "\033\[1;34m\[STEP\]\033\[0m $text"
}

proc print_success {text} {
    puts "\033\[1;32m\[âœ“\]\033\[0m $text"
}

proc print_error {text} {
    puts "\033\[1;31m\[âœ—\]\033\[0m $text"
}

print_header "DÃ‰PLOIEMENT MCP SUR HOSTINGER - AUTOMATIQUE"
puts ""

# =============================================================================
# Ã‰TAPE 1: TEST DE CONNEXION
# =============================================================================
print_step "1/6 - Test de connexion au serveur $server..."

spawn ssh -o StrictHostKeyChecking=no $user@$server "echo 'Connection OK'"
expect {
    "password:" {
        send "$password\r"
        expect {
            "Connection OK" {
                print_success "Connexion rÃ©ussie"
            }
            timeout {
                print_error "Timeout lors du test de connexion"
                exit 1
            }
        }
    }
    timeout {
        print_error "Impossible de se connecter au serveur"
        exit 1
    }
}
expect eof
puts ""

# =============================================================================
# Ã‰TAPE 2: INSTALLATION DES PRÃ‰REQUIS
# =============================================================================
print_step "2/6 - Installation des prÃ©requis (Docker, Docker Compose, Nginx)..."

spawn ssh -o StrictHostKeyChecking=no $user@$server
expect "password:"
send "$password\r"
expect "#"

# VÃ©rifier et installer Docker
send "if ! command -v docker &> /dev/null; then echo 'Installing Docker...'; curl -fsSL https://get.docker.com | sh; else echo 'Docker already installed'; fi\r"
expect "#"

# VÃ©rifier et installer Docker Compose
send "if ! command -v docker-compose &> /dev/null; then echo 'Installing Docker Compose...'; curl -L 'https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-\$(uname -s)-\$(uname -m)' -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose; else echo 'Docker Compose already installed'; fi\r"
expect "#"

# VÃ©rifier et installer Nginx
send "if ! command -v nginx &> /dev/null; then echo 'Installing Nginx...'; apt update && apt install -y nginx certbot python3-certbot-nginx; else echo 'Nginx already installed'; fi\r"
expect "#"

send "exit\r"
expect eof

print_success "PrÃ©requis installÃ©s"
puts ""

# =============================================================================
# Ã‰TAPE 3: CRÃ‰ATION DU RÃ‰PERTOIRE ET UPLOAD DES FICHIERS
# =============================================================================
print_step "3/6 - CrÃ©ation du rÃ©pertoire et upload des fichiers..."

spawn ssh -o StrictHostKeyChecking=no $user@$server "mkdir -p /opt/mcp && echo 'Directory created'"
expect "password:"
send "$password\r"
expect eof

print_success "RÃ©pertoire /opt/mcp crÃ©Ã©"

# Upload du package de dÃ©ploiement
print_step "Upload du package de dÃ©ploiement..."
spawn scp -o StrictHostKeyChecking=no $local_dir/mcp-deployment-package.tar.gz $user@$server:/opt/mcp/
expect "password:"
send "$password\r"
expect eof

# Upload des fichiers supplÃ©mentaires nÃ©cessaires
print_step "Upload des fichiers de configuration..."
spawn scp -o StrictHostKeyChecking=no -r $local_dir/config $local_dir/src $local_dir/app $user@$server:/opt/mcp/
expect "password:"
send "$password\r"
expect eof

print_success "Fichiers uploadÃ©s"
puts ""

# =============================================================================
# Ã‰TAPE 4: EXTRACTION ET CONFIGURATION
# =============================================================================
print_step "4/6 - Extraction et configuration..."

spawn ssh -o StrictHostKeyChecking=no $user@$server
expect "password:"
send "$password\r"
expect "#"

send "cd /opt/mcp\r"
expect "#"

# Extraction du package
send "tar -xzf mcp-deployment-package.tar.gz\r"
expect "#"

# Copier le template de configuration
send "cp config_production_hostinger.env .env.production\r"
expect "#"

# Rendre les scripts exÃ©cutables
send "chmod +x deploy_to_hostinger.sh\r"
expect "#"
send "chmod +x scripts/*.sh\r"
expect "#"

# CrÃ©er les rÃ©pertoires nÃ©cessaires
send "mkdir -p mcp-data/\{logs,data,rag,backups,reports\}\r"
expect "#"
send "mkdir -p logs/nginx config/qdrant backups\r"
expect "#"

send "exit\r"
expect eof

print_success "Configuration initiale terminÃ©e"
puts ""

# =============================================================================
# Ã‰TAPE 5: CONFIGURATION .env.production
# =============================================================================
print_step "5/6 - Configuration de .env.production..."

puts ""
puts "\033\[1;33mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033\[0m"
puts "\033\[1;33mâ•‘  âš ï¸  CONFIGURATION REQUISE                                       â•‘\033\[0m"
puts "\033\[1;33mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033\[0m"
puts ""
puts "Le fichier .env.production a Ã©tÃ© crÃ©Ã© avec les valeurs par dÃ©faut."
puts ""
puts "Pour que MCP fonctionne, vous DEVEZ configurer au minimum:"
puts ""
puts "  \033\[1;31mOBLIGATOIRE:\033\[0m"
puts "    â€¢ ANTHROPIC_API_KEY=sk-ant-api03-xxxxx"
puts ""
puts "  \033\[1;33mOPTIONNEL:\033\[0m"
puts "    â€¢ LNBITS_URL=https://..."
puts "    â€¢ LNBITS_ADMIN_KEY=xxxxx"
puts "    â€¢ TELEGRAM_BOT_TOKEN=xxxxx"
puts ""
puts "  \033\[1;32mDÃ‰JÃ€ CONFIGURÃ‰ (MongoDB et Redis locaux):\033\[0m"
puts "    âœ… MongoDB: mongodb://mcp_admin:...@mongodb:27017/mcp_prod"
puts "    âœ… Redis: redis://:...@redis:6379/0"
puts ""
puts -nonewline "Voulez-vous Ã©diter .env.production maintenant? (Y/n): "
flush stdout
expect_user -re "(.*)\n"
set response $expect_out(1,string)

if {$response == "" || $response == "y" || $response == "Y"} {
    puts ""
    puts "Connexion au serveur pour Ã©diter .env.production..."
    puts "Ã‰ditez le fichier, puis sauvegardez (Ctrl+X, puis Y, puis EntrÃ©e)"
    puts ""
    sleep 2
    
    spawn ssh -t -o StrictHostKeyChecking=no $user@$server "cd /opt/mcp && nano .env.production"
    expect "password:"
    send "$password\r"
    interact
    
    print_success "Configuration Ã©ditÃ©e"
} else {
    puts ""
    puts "\033\[1;33mâš ï¸  Vous devrez Ã©diter .env.production manuellement avant que MCP fonctionne:\033\[0m"
    puts "   ssh $user@$server"
    puts "   cd /opt/mcp"
    puts "   nano .env.production"
    puts ""
}
puts ""

# =============================================================================
# Ã‰TAPE 6: LANCEMENT DU DÃ‰PLOIEMENT
# =============================================================================
print_step "6/6 - Lancement du dÃ©ploiement Docker..."
puts ""

spawn ssh -o StrictHostKeyChecking=no $user@$server
expect "password:"
send "$password\r"
expect "#"

send "cd /opt/mcp\r"
expect "#"

# Lancer le script de dÃ©ploiement
send "./deploy_to_hostinger.sh\r"

# Attendre la fin du dÃ©ploiement (timeout long pour le tÃ©lÃ©chargement des images)
set timeout 1800
expect {
    "DÃ©ploiement terminÃ© avec succÃ¨s" {
        print_success "DÃ©ploiement rÃ©ussi"
    }
    "NGINX CONFIGURÃ‰ AVEC SUCCÃˆS" {
        print_success "Configuration Nginx rÃ©ussie"
    }
    timeout {
        print_error "Timeout lors du dÃ©ploiement"
    }
}

send "exit\r"
expect eof
puts ""

# =============================================================================
# VALIDATION
# =============================================================================
print_step "Validation du dÃ©ploiement..."
puts ""

spawn ssh -o StrictHostKeyChecking=no $user@$server
expect "password:"
send "$password\r"
expect "#"

send "cd /opt/mcp\r"
expect "#"

# VÃ©rifier les conteneurs
send "docker-compose -f docker-compose.production.yml ps\r"
expect "#"

# Test API
send "sleep 10 && curl -s http://localhost:8000/ | head -5\r"
expect "#"

send "exit\r"
expect eof
puts ""

# =============================================================================
# RÃ‰SUMÃ‰ FINAL
# =============================================================================
print_header "DÃ‰PLOIEMENT TERMINÃ‰"
puts ""
puts "\033\[1;32mâœ… MCP a Ã©tÃ© dÃ©ployÃ© sur $server\033\[0m"
puts ""
puts "ğŸ”— \033\[1mURLs d'accÃ¨s:\033\[0m"
puts "   â€¢ API directe:  http://$server:8000/"
puts "   â€¢ Via Nginx:    http://$server/"
puts "   â€¢ HTTPS:        https://api.dazno.de/ (aprÃ¨s configuration DNS + SSL)"
puts "   â€¢ Docs:         http://$server:8000/docs"
puts ""
puts "ğŸ“Š \033\[1mCommandes utiles:\033\[0m"
puts "   ssh $user@$server"
puts "   cd /opt/mcp"
puts "   docker-compose -f docker-compose.production.yml ps"
puts "   docker-compose -f docker-compose.production.yml logs -f"
puts "   ./scripts/validate_deployment.sh"
puts ""
puts "âš ï¸  \033\[1;33mMODE SHADOW ACTIVÃ‰\033\[0m"
puts "   Le systÃ¨me observe sans appliquer de changements rÃ©els"
puts "   Observez pendant 7-14 jours avant de dÃ©sactiver (DRY_RUN=false)"
puts ""
puts "ğŸ“š \033\[1mDocumentation:\033\[0m"
puts "   â€¢ START_HERE_DEPLOY.txt"
puts "   â€¢ MONGODB_REDIS_LOCAL_CHANGES.md"
puts ""
puts "ğŸ‰ \033\[1;32mDÃ©ploiement rÃ©ussi!\033\[0m"
puts ""

