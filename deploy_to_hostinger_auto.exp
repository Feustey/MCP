#!/usr/bin/expect -f
# deploy_to_hostinger_auto.exp
# DÃ©ploiement automatisÃ© sur serveur Hostinger

set timeout 300
set server "feustey@147.79.101.32"
set password "Feustey@AI!"
set remote_path "/home/feustey/mcp"

puts "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘                                                          â•‘"
puts "â•‘     DÃ‰PLOIEMENT AUTOMATISÃ‰ - SERVEUR HOSTINGER          â•‘"
puts "â•‘                                                          â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

puts "ğŸ“Š Configuration:"
puts "  â€¢ Serveur: $server"
puts "  â€¢ Chemin: $remote_path\n"

# PHASE 1: Test connexion SSH
puts "ğŸ” PHASE 1/6: Test de connexion SSH...\n"

spawn ssh -o StrictHostKeyChecking=no $server "echo 'Connexion SSH OK'"
expect {
    "password:" {
        send "$password\r"
        expect {
            "Connexion SSH OK" {
                puts "âœ… Connexion SSH Ã©tablie\n"
            }
            timeout {
                puts "âŒ Timeout lors du test SSH"
                exit 1
            }
        }
    }
    "Connexion SSH OK" {
        puts "âœ… Connexion SSH Ã©tablie (clÃ© SSH)\n"
    }
    timeout {
        puts "âŒ Impossible de se connecter au serveur"
        exit 1
    }
}

# PHASE 2: VÃ©rification Docker
puts "ğŸ” PHASE 2/6: VÃ©rification Docker distant...\n"

spawn ssh $server "docker --version"
expect {
    "password:" { send "$password\r" }
}
expect {
    "Docker version" {
        puts "âœ… Docker installÃ© sur le serveur\n"
    }
    "command not found" {
        puts "âŒ Docker non installÃ© sur le serveur"
        exit 1
    }
}

# PHASE 3: CrÃ©ation du rÃ©pertoire
puts "ğŸ“ PHASE 3/6: PrÃ©paration du rÃ©pertoire distant...\n"

spawn ssh $server "mkdir -p $remote_path"
expect {
    "password:" { send "$password\r" }
}
expect eof
puts "âœ… RÃ©pertoire crÃ©Ã©: $remote_path\n"

# PHASE 4: Synchronisation des fichiers
puts "ğŸ“¤ PHASE 4/6: Synchronisation des fichiers...\n"

puts "  Synchronisation de docker-compose.hostinger.yml..."
spawn rsync -az docker-compose.hostinger.yml $server:$remote_path/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation de Dockerfile.production..."
spawn rsync -az Dockerfile.production $server:$remote_path/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation de nginx-docker.conf..."
spawn rsync -az nginx-docker.conf $server:$remote_path/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation de .env..."
spawn rsync -az .env $server:$remote_path/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation du rÃ©pertoire app/..."
spawn rsync -az app/ $server:$remote_path/app/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation du rÃ©pertoire src/..."
spawn rsync -az src/ $server:$remote_path/src/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation du rÃ©pertoire config/..."
spawn rsync -az config/ $server:$remote_path/config/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "  Synchronisation de requirements.txt..."
spawn rsync -az requirements.txt $server:$remote_path/
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "âœ… Fichiers synchronisÃ©s\n"

# PHASE 5: DÃ©ploiement sur le serveur
puts "ğŸš€ PHASE 5/6: DÃ©ploiement sur le serveur...\n"

spawn ssh $server "cd $remote_path && bash -s"
expect {
    "password:" { send "$password\r" }
}

# Envoyer le script de dÃ©ploiement
send "COMPOSE_FILE=docker-compose.hostinger.yml\r"
send "echo 'âš™ï¸  ArrÃªt des services existants...'\r"
send "docker-compose -f \$COMPOSE_FILE down 2>/dev/null || true\r"
send "echo ''\r"
send "echo 'ğŸ”¨ Build de l image Docker (5-10 min)...'\r"
send "docker-compose -f \$COMPOSE_FILE build --no-cache mcp-api\r"
send "echo ''\r"
send "echo 'ğŸ—„ï¸  DÃ©marrage de MongoDB...'\r"
send "docker-compose -f \$COMPOSE_FILE up -d mongodb\r"
send "sleep 10\r"
send "echo 'ğŸ’¾ DÃ©marrage de Redis...'\r"
send "docker-compose -f \$COMPOSE_FILE up -d redis\r"
send "sleep 5\r"
send "echo 'ğŸ¤– DÃ©marrage d Ollama...'\r"
send "docker-compose -f \$COMPOSE_FILE up -d ollama\r"
send "sleep 15\r"
send "echo 'ğŸš€ DÃ©marrage de l API MCP...'\r"
send "docker-compose -f \$COMPOSE_FILE up -d mcp-api\r"
send "sleep 20\r"
send "echo 'ğŸŒ DÃ©marrage de Nginx...'\r"
send "docker-compose -f \$COMPOSE_FILE up -d nginx\r"
send "sleep 5\r"
send "echo ''\r"
send "echo 'âœ… Tous les services dÃ©marrÃ©s'\r"
send "echo ''\r"
send "docker-compose -f \$COMPOSE_FILE ps\r"
send "exit\r"

expect eof

# PHASE 6: VÃ©rification
puts "\nğŸ” PHASE 6/6: VÃ©rification des services...\n"

spawn ssh $server "cd $remote_path && docker-compose -f docker-compose.hostinger.yml ps"
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘                                                          â•‘"
puts "â•‘     âœ… DÃ‰PLOIEMENT PRODUCTION TERMINÃ‰ !                 â•‘"
puts "â•‘                                                          â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

puts "ğŸ¯ Commandes utiles:\n"
puts "  â€¢ Voir les logs:"
puts "    ssh $server 'cd $remote_path && docker-compose -f docker-compose.hostinger.yml logs -f'\n"
puts "  â€¢ VÃ©rifier l'Ã©tat:"
puts "    ssh $server 'cd $remote_path && docker-compose -f docker-compose.hostinger.yml ps'\n"

puts "ğŸŒ AccÃ¨s Ã  l'API:"
puts "    http://147.79.101.32:8000/health\n"

puts "âœ… DÃ©ploiement rÃ©ussi !\n"
