#\!/usr/bin/expect -f

set timeout 30
spawn ssh root@147.79.101.32

expect "*password:*"
send "Criteria0-Cadmium5-Attempt9-Exit2-Floss1\r"

expect "*#*"
send "cd /home/feustey/MCP\r"

expect "*#*"
send "echo 'ðŸ”§ TEST ALTERNATIVE: CADDY PROXY'\r"

expect "*#*"
send "echo '=================================='\r"

expect "*#*"
send "docker stop mcp-nginx 2>/dev/null; docker rm mcp-nginx 2>/dev/null\r"

expect "*#*"
send "echo '1. Configuration Caddy:'\r"

expect "*#*"
send "cat > /tmp/Caddyfile << 'EOFF'\r"

expect "*#*"
send "api.dazno.de:80 {\r"

expect "*#*"
send "    reverse_proxy 172.17.0.1:8000\r"

expect "*#*"
send "}\r"

expect "*#*"
send "api.dazno.de:8080 {\r"

expect "*#*"
send "    reverse_proxy 172.17.0.1:8000\r"

expect "*#*"
send "}\r"

expect "*#*"
send "EOFF\r"

expect "*#*"
send "echo '2. DÃ©marrage Caddy:'\r"

expect "*#*"
send "docker run -d --name mcp-caddy --restart unless-stopped -p 80:80 -p 8080:8080 -v /tmp/Caddyfile:/etc/caddy/Caddyfile:ro caddy:alpine\r"

expect "*#*"
send "sleep 5\r"

expect "*#*"
send "echo '3. Test Caddy:'\r"

expect "*#*"
send "curl -s -o /dev/null -w 'Caddy 80: %{http_code}' http://localhost/health && echo\r"

expect "*#*"
send "curl -s -o /dev/null -w 'Caddy 8080: %{http_code}' http://localhost:8080/health && echo\r"

expect "*#*"
send "docker ps | grep caddy\r"

expect "*#*"
send "exit\r"

expect eof
EOF < /dev/null
