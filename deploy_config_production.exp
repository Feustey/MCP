#!/usr/bin/expect -f

set timeout 180
set host "147.79.101.32"
set user "root"
set password "Criteria0-Cadmium5-Attempt9-Exit2-Floss1"
set local_config "/Users/stephanecourant/Documents/DAZ/MCP/MCP/config.py"
set remote_path "/root/domains/api.dazno.de/MCP/"

log_user 1

puts "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘   DÃ©ploiement config.py - Fix 'Invalid Host Header'    â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"

# Ã‰tape 1: TransfÃ©rer le fichier config.py
puts "\[1/5\] Transfert de config.py vers le serveur de production..."
spawn scp -o StrictHostKeyChecking=no $local_config $user@$host:$remote_path

expect {
    timeout { 
        puts "\nâŒ Erreur: Timeout lors du transfert SCP"
        exit 1
    }
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Permission denied" {
        puts "\nâŒ Erreur: Permission refusÃ©e"
        exit 1
    }
    eof {
        wait
        if {[lindex $::errorCode 0] eq "CHILDSTATUS"} {
            set exitstatus [lindex $::errorCode 2]
            if {$exitstatus == 0} {
                puts "âœ… Fichier config.py transfÃ©rÃ© avec succÃ¨s"
            } else {
                puts "\nâŒ Erreur lors du transfert (code: $exitstatus)"
                exit 1
            }
        }
    }
}

sleep 2

# Ã‰tape 2: Connexion SSH
puts "\n\[2/5\] Connexion SSH au serveur de production..."
spawn ssh -o StrictHostKeyChecking=no $user@$host

expect {
    timeout { 
        puts "\nâŒ Erreur: Timeout lors de la connexion SSH"
        exit 1
    }
    "Permission denied" {
        puts "\nâŒ Erreur: Permission SSH refusÃ©e"
        exit 1
    }
    "password:" {
        send "$password\r"
    }
}

expect {
    timeout { 
        puts "\nâŒ Erreur: Timeout aprÃ¨s connexion"
        exit 1
    }
    "Permission denied" {
        puts "\nâŒ Erreur: Mauvais mot de passe SSH"
        exit 1
    }
    -re "#|root@" {
        puts "âœ… ConnectÃ© en tant que root\n"
    }
}

# Attendre le prompt
expect -re "#"

# Naviguer vers le rÃ©pertoire
send "cd /root/domains/api.dazno.de/MCP\r"
expect -re "#"

# VÃ©rifier que le fichier a bien Ã©tÃ© copiÃ©
puts "\n\[3/5\] VÃ©rification de la modification dans config.py..."
send "grep -n 'api.dazno.de.*app.dazno.de' config.py\r"
expect -re "#"
sleep 1

# Afficher la ligne modifiÃ©e
send "sed -n '106p' config.py\r"
expect -re "#"

# Rebuild de l'image Docker
puts "\n\[4/5\] Reconstruction de l'image Docker mcp-api..."
puts "(Cela peut prendre 1-3 minutes, veuillez patienter...)\n"
send "docker-compose -f docker-compose.hostinger.yml build mcp-api 2>&1 | tail -20\r"

set timeout 300
expect {
    timeout { 
        puts "\nâš ï¸  Warning: Build timeout, vÃ©rification du statut..."
    }
    -re "(Successfully built|Successfully tagged)" {
        puts "\nâœ… Image Docker reconstruite avec succÃ¨s"
    }
    -re "#" { }
}

set timeout 120

# RedÃ©marrage du conteneur
puts "\nRedÃ©marrage du conteneur mcp-api..."
send "docker-compose -f docker-compose.hostinger.yml up -d mcp-api\r"
expect -re "#"
sleep 10

# VÃ©rification du statut
puts "\n\[5/5\] VÃ©rifications post-dÃ©ploiement..."
puts "\n--- Statut du conteneur ---"
send "docker ps --filter name=mcp-api --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'\r"
expect -re "#"
sleep 2

# Logs de dÃ©marrage
puts "\n--- Logs de dÃ©marrage (15 derniÃ¨res lignes) ---"
send "docker logs mcp-api --tail=15 2>&1\r"
expect -re "#"
sleep 2

# Test du endpoint health
puts "\n--- Test endpoint /health ---"
send "curl -s http://localhost:8000/health 2>&1 | head -3\r"
expect -re "#"
sleep 2

# Test du endpoint docs avec le nouveau host autorisÃ©
puts "\n--- Test HTTPS /docs (api.dazno.de) ---"
send "curl -I -L https://api.dazno.de/docs 2>&1 | head -10\r"
expect -re "#"
sleep 2

# VÃ©rifier dans les logs que allowed_hosts est bien chargÃ©
puts "\n--- VÃ©rification allowed_hosts dans les logs ---"
send "docker logs mcp-api 2>&1 | grep -i 'allowed.*host' | tail -5\r"
expect -re "#"

puts "\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
puts "â•‘          âœ… DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS             â•‘"
puts "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
puts "\nğŸ“‹ Actions effectuÃ©es:"
puts "  âœ… config.py transfÃ©rÃ© avec 'api.dazno.de' dans allowed_hosts"
puts "  âœ… Image Docker mcp-api reconstruite"
puts "  âœ… Conteneur mcp-api redÃ©marrÃ©"
puts "  âœ… VÃ©rifications post-dÃ©ploiement effectuÃ©es"
puts "\nğŸŒ TESTEZ MAINTENANT:"
puts "   ğŸ‘‰ https://api.dazno.de/docs"
puts "\nğŸ’¡ L'erreur 'invalid host header' devrait Ãªtre rÃ©solue."
puts "   Si elle persiste, attendez 30-60 secondes que le conteneur"
puts "   finisse son initialisation complÃ¨te.\n"

send "exit\r"
expect eof

exit 0
